# 未来自动化计划日志

**创建日期**：2025-11-26  
**版本**：1.0  
**状态**：规划中

---

## 一、计划目标

实现从 JSON 文件到 `pacedSpeech` 的完全自动化处理流程，消除手动步骤，集成到构建流程中。

---

## 二、当前状态分析

### 2.1 已完成的自动化部分

✅ **SRE 转换自动化**：
- `sreConverter.py` 可以自动将 `Pre.txt` 转换为 `Post.txt`
- 使用 Node.js SRE 脚本进行 LaTeX 到语音的转换

✅ **Lambda TTS 服务**：
- 运行时音频生成已自动化
- S3 缓存已实现

### 2.2 仍需手动处理的部分

❌ **从 JSON 到 `Pre.txt` 的转换**：
- 需要手动运行 Jupyter Notebook
- 需要手动处理文本分段和数学提取

❌ **从 `Post.txt` 到 `pacedSpeech` 的整合**：
- 需要手动运行 Jupyter Notebook
- 需要手动运行 `mtsPacedWriter.py`

❌ **构建时集成**：
- 构建流程不包含 TTS 处理
- 新内容需要手动处理

---

## 三、自动化计划

### 3.1 阶段 1：核心处理模块（高优先级）

#### 目标
创建可以直接从 JSON 文件生成 `pacedSpeech` 的核心处理模块。

#### 任务清单

**任务 1.1：创建文本解析工具**
- **文件**：`src/math-to-speech/utils/textParser.js`
- **功能**：
  - 解析文本和 LaTeX（提取 `$$LaTeX$$` 表达式）
  - 分段处理（按 `;` 和 `@` 分隔符）
  - 提取纯文本和数学公式部分
- **依赖**：无
- **预计工作量**：2-3 小时

**任务 1.2：创建 LaTeX 转换工具**
- **文件**：`src/math-to-speech/utils/latexConverter.js`
- **功能**：
  - 封装 SRE 转换逻辑
  - 调用 `sreNode.js` 进行 MathML 到语音转换
  - 处理转换错误和回退
- **依赖**：`sreNode.js`（已存在）
- **预计工作量**：2-3 小时

**任务 1.3：创建核心处理逻辑**
- **文件**：`src/math-to-speech/scripts/ttsProcessor.js`
- **功能**：
  - `generatePacedSpeech(text)`：从文本生成 `pacedSpeech` 数组
  - `needsProcessing(hint, options)`：判断是否需要处理
  - 整合文本解析和 LaTeX 转换
- **依赖**：`textParser.js`, `latexConverter.js`
- **预计工作量**：4-5 小时

#### 验收标准
- [ ] 可以从包含 LaTeX 的文本生成 `pacedSpeech` 数组
- [ ] 正确处理纯文本和数学公式
- [ ] 错误处理完善
- [ ] 单元测试通过

---

### 3.2 阶段 2：自动化处理脚本（高优先级）

#### 目标
创建统一的自动化处理脚本，支持 CLI 和模块两种使用方式。

#### 任务清单

**任务 2.1：创建主处理脚本**
- **文件**：`src/math-to-speech/scripts/autoProcessor.js`
- **功能**：
  - 扫描 JSON 文件（查找 `DefaultPathway.json`）
  - 处理单个文件或批量处理
  - 支持命令行参数（`--force`, `--file`, `--dir`）
  - 内容变化检测（hash 检查）
  - 进度显示和错误报告
- **依赖**：`ttsProcessor.js`
- **预计工作量**：6-8 小时

**任务 2.2：添加 CLI 命令**
- **文件**：`package.json`
- **功能**：
  - `npm run process-tts`：处理所有文件
  - `npm run process-tts:force`：强制重新生成
  - `npm run process-tts:file <path>`：处理单个文件
- **依赖**：`autoProcessor.js`
- **预计工作量**：1 小时

**任务 2.3：内容变化检测**
- **功能**：
  - 计算 `text` 字段的 hash
  - 与缓存的 hash 比较
  - 只处理变化的内容
- **实现位置**：`ttsProcessor.js` 中的 `needsProcessing()`
- **预计工作量**：2-3 小时

#### 验收标准
- [ ] 可以处理单个 JSON 文件
- [ ] 可以批量处理所有文件
- [ ] 支持命令行参数
- [ ] 内容变化检测正常工作
- [ ] 错误处理和日志完善

---

### 3.3 阶段 3：构建时集成（中优先级）

#### 目标
将 TTS 处理集成到构建流程中，确保构建时自动处理。

#### 任务清单

**任务 3.1：集成到预处理脚本**
- **文件**：`src/tools/preprocessProblemPool.js`
- **功能**：
  - 在处理 hint pathway 时调用 `processFile()`
  - 检查 `pacedSpeech` 是否存在
  - 自动生成缺失的 `pacedSpeech`
  - 支持增量更新
- **依赖**：`autoProcessor.js`
- **预计工作量**：4-5 小时

**任务 3.2：构建流程优化**
- **功能**：
  - 确保构建时自动处理
  - 不影响现有构建流程
  - 错误时不影响构建
- **实现位置**：`preprocessProblemPool.js`
- **预计工作量**：2-3 小时

#### 验收标准
- [ ] 运行 `npm run build` 时自动处理 TTS
- [ ] 新内容自动生成 `pacedSpeech`
- [ ] 构建流程不受影响
- [ ] 错误处理不影响构建

---

### 3.4 阶段 4：高级功能（低优先级）

#### 目标
添加高级功能，提升开发体验和系统灵活性。

#### 任务清单

**任务 4.1：文件监听器（开发时）**
- **文件**：`src/math-to-speech/scripts/fileWatcher.js`
- **功能**：
  - 监听 JSON 文件变化
  - 自动处理变化的文件
  - 开发时实时更新
- **依赖**：`chokidar` 或 `nodemon`
- **预计工作量**：4-5 小时

**任务 4.2：缓存优化**
- **功能**：
  - 缓存 SRE 转换结果
  - 避免重复转换相同内容
  - 提升处理速度
- **实现位置**：`latexConverter.js`
- **预计工作量**：3-4 小时

**任务 4.3：进度显示和统计**
- **功能**：
  - 显示处理进度
  - 统计处理结果
  - 生成处理报告
- **实现位置**：`autoProcessor.js`
- **预计工作量**：2-3 小时

#### 验收标准
- [ ] 文件监听器正常工作
- [ ] 缓存机制有效
- [ ] 进度显示清晰
- [ ] 统计信息准确

---

## 四、实施时间表

### 4.1 短期（1-2 周）

**目标**：完成核心功能，实现基本的自动化处理

- **第 1 周**：
  - 完成阶段 1（核心处理模块）
  - 开始阶段 2（自动化处理脚本）

- **第 2 周**：
  - 完成阶段 2（自动化处理脚本）
  - 测试和优化

### 4.2 中期（3-4 周）

**目标**：集成到构建流程，实现完全自动化

- **第 3 周**：
  - 完成阶段 3（构建时集成）
  - 全面测试

- **第 4 周**：
  - 优化和修复问题
  - 文档完善

### 4.3 长期（5-8 周）

**目标**：添加高级功能，提升开发体验

- **第 5-6 周**：
  - 完成阶段 4（高级功能）
  - 性能优化

- **第 7-8 周**：
  - 全面测试
  - 文档和培训

---

## 五、技术架构

### 5.1 文件结构

```
src/
├── math-to-speech/
│   ├── scripts/
│   │   ├── autoProcessor.js          # 主处理脚本（新建）
│   │   ├── ttsProcessor.js           # 核心处理逻辑（新建）
│   │   ├── fileWatcher.js            # 文件监听器（新建，可选）
│   │   ├── sreNode.js                # SRE 转换（已存在）
│   │   ├── sreConverter.py           # Python SRE 转换（已存在）
│   │   └── mtsPacedWriter.py         # Python 写入脚本（已存在，可废弃）
│   └── utils/
│       ├── textParser.js             # 文本解析工具（新建）
│       └── latexConverter.js         # LaTeX 转换工具（新建）
└── tools/
    └── preprocessProblemPool.js      # 构建预处理（修改）
```

### 5.2 数据流

```
JSON 文件（text 字段）
  ↓
textParser.js（解析文本和 LaTeX）
  ↓
latexConverter.js（LaTeX → Speech）
  ↓
ttsProcessor.js（生成 pacedSpeech 数组）
  ↓
autoProcessor.js（写入 JSON 文件）
  ↓
JSON 文件（pacedSpeech 字段）
```

### 5.3 处理流程

```
1. 扫描 JSON 文件
2. 检查是否需要处理（needsProcessing）
3. 解析文本和 LaTeX（textParser）
4. 转换 LaTeX 到语音（latexConverter）
5. 生成 pacedSpeech 数组（ttsProcessor）
6. 写入 JSON 文件（autoProcessor）
7. 记录处理结果
```

---

## 六、风险和挑战

### 6.1 技术风险

**风险 1：SRE 转换性能**
- **问题**：大量 LaTeX 转换可能较慢
- **缓解**：实现缓存机制，批量处理优化

**风险 2：JSON 文件格式变化**
- **问题**：JSON 结构变化可能导致处理失败
- **缓解**：完善的错误处理和格式验证

**风险 3：构建流程影响**
- **问题**：集成到构建流程可能影响构建速度
- **缓解**：增量更新，只处理变化的内容

### 6.2 实施风险

**风险 1：现有脚本依赖**
- **问题**：可能依赖现有 Python 脚本的某些功能
- **缓解**：仔细分析现有脚本，确保功能完整迁移

**风险 2：测试覆盖不足**
- **问题**：自动化处理可能引入错误
- **缓解**：完善的单元测试和集成测试

---

## 七、成功标准

### 7.1 功能完整性

- [ ] 可以从 JSON 文件直接生成 `pacedSpeech`
- [ ] 支持批量处理所有文件
- [ ] 支持单个文件处理
- [ ] 构建时自动处理
- [ ] 内容变化检测正常工作

### 7.2 性能指标

- [ ] 处理速度：单个 hint < 1 秒
- [ ] 批量处理：100 个 hint < 5 分钟
- [ ] 构建时间增加：< 10%

### 7.3 用户体验

- [ ] 无需手动步骤
- [ ] 错误信息清晰
- [ ] 进度显示友好
- [ ] 文档完善

---

## 八、依赖和前置条件

### 8.1 技术依赖

- Node.js 环境（已满足）
- Python 环境（SRE 转换，已满足）
- `speech-rule-engine` 库（已安装）

### 8.2 代码依赖

- `sreNode.js`（已存在）
- `sreConverter.py`（已存在，可参考）
- `preprocessProblemPool.js`（已存在，需修改）

### 8.3 数据依赖

- JSON 文件结构（已确定）
- `pacedSpeech` 格式（已确定）

---

## 九、后续优化方向

### 9.1 性能优化

1. **并行处理**：使用 `Promise.all` 并行处理多个文件
2. **增量更新**：只处理变化的内容
3. **缓存机制**：缓存 SRE 转换结果

### 9.2 功能扩展

1. **变量支持**：支持运行时变量替换后的 TTS 生成
2. **多语言支持**：支持不同语言的 TTS
3. **语音选择**：支持不同的语音类型

### 9.3 监控和统计

1. **处理统计**：记录处理时间和成功率
2. **错误监控**：记录和处理错误
3. **性能监控**：监控处理性能

---

## 十、总结

### 10.1 核心目标

实现从 JSON 文件到 `pacedSpeech` 的完全自动化处理，消除手动步骤，集成到构建流程中。

### 10.2 关键里程碑

1. **阶段 1**：核心处理模块（1-2 周）
2. **阶段 2**：自动化处理脚本（2-3 周）
3. **阶段 3**：构建时集成（3-4 周）
4. **阶段 4**：高级功能（5-8 周）

### 10.3 预期收益

- **效率提升**：减少手动工作 90%+
- **一致性**：确保所有内容都有 `pacedSpeech`
- **可维护性**：统一的处理流程，易于维护
- **可扩展性**：支持未来功能扩展

---

**文档版本**：1.0  
**创建日期**：2025-11-26  
**维护者**：OATutor 开发团队  
**状态**：规划中，待实施

