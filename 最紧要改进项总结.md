# OATutor TTS 系统 - 最紧要改进项总结

## 一、核心发现

### 当前状态
- ✅ 系统支持 variabilization 机制（代码完整）
- ❌ **当前内容库中没有使用变量**（所有 `variabilization` 都是 `{}`）
- ✅ 预生成的 `pacedSpeech` 可以直接使用（无需运行时处理）
- ✅ JSON 文件中已包含 `pacedSpeech` 数组

### 关键问题
1. **手动处理流程**：需要手动复制粘贴 120+ 提示
2. **无缓存机制**：每次都要重新请求音频，浪费 API 调用
3. **硬编码的 AWS Lambda URL**：不灵活，无法本地开发
4. **无自动化处理**：内容更新需要手动重新运行整个流程

---

## 二、最紧要的 5 个改进项

### 🔥 优先级 1：自动化内容处理管道（最紧急）

**问题**：
- 需要手动复制粘贴 120+ 提示到处理脚本
- 内容更新需要重新运行整个流程
- 容易出错，效率低下

**解决方案**：
- 创建自动化脚本 `autoProcessor.js`
- 自动扫描所有 JSON 文件
- 自动生成缺失的 `pacedSpeech`
- 集成到构建流程（`preprocessProblemPool.js`）

**实施步骤**：
1. 创建 `src/math-to-speech/scripts/autoProcessor.js`
2. 扫描所有 `DefaultPathway.json` 文件
3. 检查每个 hint 是否有 `pacedSpeech`
4. 如果没有，自动生成（使用 SRE 转换 LaTeX）
5. 更新 JSON 文件
6. 集成到构建流程

**预期效果**：
- 减少手动工作 90%+
- 内容更新自动化
- 确保所有内容都有 `pacedSpeech`

---

### 🔥 优先级 2：缓存系统（高优先级）

**问题**：
- 每次播放都要重新请求音频
- 相同内容的重复 API 调用
- 浪费 API 配额和成本
- 加载时间长

**解决方案**：
- **三层缓存策略**：
  1. **会话内缓存**（内存）：同一会话内快速访问
  2. **浏览器缓存**（IndexedDB）：跨会话，避免重复下载
  3. **服务器端缓存**（可选）：减少 API 调用

**缓存键**（简化版，因为当前无变量）：
```javascript
const cacheKey = `${problemID}-${stepID}-${hintID}`;
```

**实施步骤**：
1. 创建缓存工具函数 `src/util/ttsUtils.js`
2. 实现会话内缓存（Map 或 Context）
3. 实现浏览器缓存（IndexedDB）
4. 在 `HintSystem` 中集成缓存检查
5. 缓存音频 blob 和元数据

**预期效果**：
- 减少 API 调用 80%+
- 提升加载速度
- 降低 API 成本

---

### 🔥 优先级 3：后端服务器实现（高优先级）

**问题**：
- 硬编码的 AWS Lambda URL
- 无法本地开发和测试
- 没有错误处理和回退机制
- OpenAI TTS 代码存在但未集成

**解决方案**：
- 创建 Express.js 后端服务器
- 支持 OpenAI TTS 和 AWS Polly
- 可配置的端点
- 错误处理和回退机制

**实施步骤**：
1. 创建 `src/tts-server/server.js`
2. 实现 `/synthesize` 端点
3. 集成 OpenAI TTS API
4. 添加错误处理和重试逻辑
5. 环境变量配置（API keys, endpoints）

**预期效果**：
- 支持本地开发
- 灵活的 TTS 提供商选择
- 更好的错误处理

---

### 🔥 优先级 4：用户切换和配置（中高优先级）

**问题**：
- 用户无法控制 TTS 功能
- 没有视觉指示器
- 硬编码的设置

**解决方案**：
- 添加 TTS 切换按钮
- 用户偏好存储（localStorage）
- 视觉指示器
- 配置系统

**实施步骤**：
1. 创建 `src/components/accessibility/TTSToggle.js`
2. 在应用栏添加切换按钮
3. 实现用户偏好存储
4. 创建 TTS Context 管理全局状态
5. 添加配置系统 `src/config/ttsConfig.js`

**预期效果**：
- 用户可控制功能
- 改善用户体验
- 符合无障碍标准

---

### 🔥 优先级 5：错误处理和健壮性（中优先级）

**问题**：
- 有限的错误处理
- 没有重试逻辑
- 音频不可用时没有优雅降级
- 失败时用户体验差

**解决方案**：
- 完善的错误处理
- 重试逻辑
- 优雅降级（显示文本而不是音频）
- 用户友好的错误提示

**实施步骤**：
1. 在 `HintSystem` 中添加错误边界
2. 实现重试逻辑（最多 3 次）
3. 添加加载状态和错误状态
4. 优雅降级到文本显示
5. 错误日志记录

**预期效果**：
- 更稳定的用户体验
- 更好的错误诊断
- 系统更健壮

---

## 三、实施时间线

### 第 1 周：基础自动化
- ✅ 自动化内容处理管道
- ✅ 缓存系统（会话内 + 浏览器）

### 第 2 周：后端和配置
- ✅ 后端服务器实现
- ✅ 用户切换和配置
- ✅ 错误处理

### 第 3-4 周：优化和测试
- ✅ 性能优化
- ✅ 测试和调试
- ✅ 文档完善

---

## 四、关键决策

### 1. 缓存策略
- **当前**：基于 `problemID + stepID + hintID`（无变量）
- **未来**：保留扩展性，支持变量时添加 seed

### 2. 自动化处理
- **构建时**：自动生成缺失的 `pacedSpeech`
- **运行时**：直接使用预生成的 `pacedSpeech`

### 3. 后端架构
- **开发环境**：本地 Express.js 服务器
- **生产环境**：可配置（本地服务器或 AWS Lambda）

---

## 五、成功指标

### 功能指标
- ✅ 100% 的内容都有 `pacedSpeech`
- ✅ 自动化处理覆盖率 100%
- ✅ 缓存命中率 > 80%

### 性能指标
- ✅ 音频加载时间 < 500ms（缓存命中）
- ✅ API 调用减少 80%+
- ✅ 错误率 < 1%

### 用户体验指标
- ✅ 用户可控制 TTS 功能
- ✅ 错误时有友好的提示
- ✅ 系统稳定可靠

---

## 六、下一步行动

### 立即开始
1. **创建自动化处理脚本**
   - 文件：`src/math-to-speech/scripts/autoProcessor.js`
   - 功能：自动扫描和生成 `pacedSpeech`

2. **实现缓存系统**
   - 文件：`src/util/ttsUtils.js`
   - 功能：缓存管理和工具函数

3. **修改 HintSystem**
   - 集成缓存检查
   - 使用预生成的 `pacedSpeech`
   - 添加错误处理

### 短期完成
4. **后端服务器**
   - 文件：`src/tts-server/server.js`
   - 功能：TTS API 端点

5. **用户切换**
   - 文件：`src/components/accessibility/TTSToggle.js`
   - 功能：用户控制界面

---

## 七、注意事项

### 1. 保留扩展性
- 虽然当前没有变量，但代码应该支持未来扩展
- 检查 `variabilization` 是否为空
- 缓存键生成函数应该支持变量

### 2. 向后兼容
- 确保没有 `pacedSpeech` 的内容也能工作
- 运行时生成作为回退方案

### 3. 性能考虑
- 缓存策略要平衡存储和性能
- 避免缓存过大导致内存问题
- 定期清理过期缓存

---

**总结**：最紧要的是**自动化处理**和**缓存系统**，这两个改进可以立即提升效率和性能。其次是**后端服务器**和**用户控制**，这些可以改善开发体验和用户体验。




